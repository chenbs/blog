title: es进阶(2)
date: 2016-01-28 15:56:25
tags:
- es
- elk

# es进阶(2)

## 分布式搜索

### 分布式搜索的执行方式

一个CRUD操作只处理一个单独的文档。文档的唯一性由_index, _type和routing-value（通常默认是该文档的_id）的组合来确定。这意味着我们可以准确知道集群中的哪个分片持有这个文档。

由于不知道哪个文档会匹配查询（文档可能存放在集群中的任意分片上），所以搜索需要一个更复杂的模型。一个搜索不得不通过查询每一个我们感兴趣的索引的分片副本，来看是否含有任何匹配的文档。

但是，找到所有匹配的文档只完成了这件事的一半。在搜索（search）API返回一页结果前，来自多个分片的结果必须被组合放到一个有序列表中。因此，搜索的执行过程分两个阶段，称为查询然后取回（query then fetch）。	

### 查询阶段

在初始化**查询阶段（query phase）**，查询被向索引中的每个分片副本（原本或副本）**广播**。每个分片在本地执行搜索并且建立了匹配document的**优先队列（priority queue）**。

### 取回阶段

查询阶段辨别出那些满足搜索请求的document，但我们仍然需要取回那些document本身。这就是取回阶段的工作。

#### 深分页

### 搜索选项

一些查询字符串（query-string）可选参数能够影响搜索过程。

* preference（偏爱）
* timeout（超时）
* routing（路由选择）
* search_type（搜索类型）

### 扫描和滚屏

**scan（扫描）**搜索类型是和**scroll（滚屏）API**一起使用来从Elasticsearch里高效地取回巨大数量的结果而不需要付出深分页的代价。

* scroll（滚屏）

	一个滚屏搜索允许我们做一个初始阶段搜索并且持续批量从Elasticsearch里拉取结果直到没有结果剩下。这有点像传统数据库里的cursors（游标）。
	
* scan（扫描）

	深度分页代价最高的部分是对结果的全局排序，但如果禁用排序，就能以很低的代价获得全部返回结果。为达成这个目的，可以采用scan（扫描）搜索模式。扫描模式让Elasticsearch不排序，只要分片里还有结果可以返回，就返回一批结果。
	
为了使用**scan-and-scroll（扫描和滚屏）**，需要执行一个搜索请求，将search_type 设置成scan，并且传递一个scroll参数来告诉Elasticsearch滚屏应该持续多长时间

	GET /old_index/_search?search_type=scan&scroll=1m
	{
	    "query": { "match_all": {}},
	    "size":  1000
	}		


## 索引管理

*(未完待续)*

## 深入分片

*(未完待续)*







